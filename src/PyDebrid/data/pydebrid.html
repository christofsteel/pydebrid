<!doctype html>
<html lang="de">
	<head>
		<title>pyDebrid</title>
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
		<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
		<script src="http://tinysort.sjeiti.com/src/jquery.tinysort.min.js"></script>
		<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
		<script>
			function addMessage(message) {
				div = $('<div>', {'class': 'alert alert-success in fade'});
				span = $('<span>', {'text': message});
				button = $('<button>', {'type': 'button', 'class': 'close', 'data-dismiss': 'alert'});
				closei = $('<i>', {'class': 'icon-remove'});
				button.append(closei);
				div.append(span);
				div.append(button);
				$('#messagearea').append(div);
			}
			function genElement(e) {
				e['perc'] = Math.round((e['completed'] / e['filesize'])*1000)/10
				li = $('<li>')
				li.data(e)
				li.attr('id', e['id']);
				li.attr('class', 'alert alert-info in fade');
				closebutton = $('<a>', {href: 'javascript:remove("' + e['id']+'")', 'class': 'close'});
				closei = $('<i>', {'class': 'icon-remove'})
				restartbutton = $('<a>', {href: 'javascript:restart("' + e['id']+'")', 'class': 'close'});
				restarti = $('<i>', {'class': 'icon-refresh'})
				text = $('<strong>', {text: e['filename']});
				barcontainer = $('<div>', {'class': 'progress'});
				bar = $('<div>', {'class': 'bar'});
				bar.css('width', e['perc'] + '%');
				percdiv = $('<div>', {'class': 'perc', text: e['perc'] + '%'});
				rate = $('<div>', {'class': 'rate', text: Math.round(e['rate']/102.4)/10 + ' kB/s'});
				barcontainer.append(bar);
				closebutton.append(closei);
				li.append(closebutton);
				restartbutton.append(restarti);
				li.append(restartbutton);
				li.append(text);
				li.append(barcontainer);
				li.append(percdiv);
				li.append(rate);
				return(li);
			}
			function compare(a, b) {
				return($(a).data()['perc'] > $(b).data()['perc']);
			}

			function remove(id) {
				$.getJSON('/remove/' + id, function(data) {
					addMessage(data['message']);
					$('#'+id).remove()
				})
			}
			function setPerc(id, link) {
				$('#' + id).data(link)
				$('#' + id).data()['perc'] = Math.round(($('#' + id).data()['completed'] / $('#' + id).data()['filesize'])*1000)/10
				$('#'+ id + ' .perc').text($('#' + id).data()['perc'] + '%');
				$('#'+ id + ' .rate').text(Math.round($('#' + id).data()['rate']/102.4)/10 + ' kB/s');
				// $('#'+ id).data()['perc'] = link['perc'];

			}
			function update() {
				$.getJSON('/list', function(data) {
/*					var idPercDict = {}
					$('#queue li').each(function (element) {
						idPercDict[$(this).attr('id')] = $(this).attr('data-perc');
					});
					linklist = data['links'];
					$('#queue').empty();
					for(i = 0; i < linklist.length; i++) {
						link = linklist[i];
						perc = link['perc'];
						link['perc'] = idPercDict[link['id']];
						elem = genElement(link);
						$('#queue').prepend(elem);
						link['perc'] = perc;
						setPerc(link['id'], perc);
					}*/

				  $('#queue li').each(function (element) {
					  if(data[$(this).attr('id')] == undefined) {
						  $(this).remove();
						  } else {
					  }
				  });
				  $.each(data, function(key, val) {
					  if( $('li#' + key).length == 0 && !(val['cancled'])) {
						$('#queue').append(genElement(val));
					} else {
						setPerc(key, val);

					}
				  });
//				  $('#queue li').tsort({data:'perc'});
				  $list = $('#queue');
				  $listLi = $('li', $list);
				  $listLi.sort(compare);
				  $.each($listLi, function(index, row){
						$list.prepend(row);
				    });

				  // Resize the Bars
				  $('#queue li').each(function(id) {
					  perc = $(this).data('perc');
					  $(this).find('.bar').css('width', perc + "%");
				  });
				});
				timer = window.setTimeout(update, 1000)
			}

			$('.alert').alert();
			$('#nav a').click(function (e) {
				  e.preventDefault();
				  $(this).tab('show');
				});

			window.setTimeout(update, 1000)
		</script>
		<style type='text/css'>
			body {
				background-color: #CCC;
			}
		</style>
	</head>
	<body>
		<div class="container" style="padding: 15px; background: white; border-radius: 15px;">
			<div class="row">
				<div class="span12" style="text-align: center;">
					<h1 class="page-header">pyDebrid</h1>
				</div>
			</div>
				<ul class="nav nav-tabs" id="nav">
					<li class="active"><a href="#och" data-toggle="tab">One Click Hoster</a></li>
					<li><a href="#ddl" data-toggle="tab">Direct Download</a></li>
					<li><a href="#serienjunkies" data-toggle="tab">SerienJunkies</a></li>
					<li><a href="#torrent" data-toggle="tab">Torrent</a></li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane active" id="och">
							<form id="och_form" class="sendlinks" action="/add_och" method="post">
								<textarea name="och_links" class="field span12" rows="5" placeholder="http://download.com/1337/file.tar.gz"></textarea>
								<input type="submit" class="btn btn-primary" value="Add" />
								<button type="button" class="btn" data-toggle="collapse" data-target="#och_collapse">
									Options
								</button>
								<div class="collapse" id="och_collapse">
									<div class="well">
										<label for="unpack" class="checkbox"><input type="checkbox" value="unpack" name="unpack" id="unpack">Auto unpack</label>
										<label for="password"><input type="text" placeholder="Password" id="password" name="password"></label>
									</div>
								</div>
							</form>
					</div>
					<div class="tab-pane" id="ddl">
						<form action="/add_ddl" class="sendlinks" method="post">
							<textarea name="ddl_links" class="field span12" rows="5" placeholder="http://download.com/file.tar.gz"></textarea>
							<input type="submit" class="btn btn-primary" value="Add" />
						</form>
					</div>
					<div class="tab-pane" id="serienjunkies">
						<form action="/sj" method="post">
							<div class="input-append">
								<input type="text" name="link" />
								<input type="submit" class="btn" value="Get Secure IMG" />
							</div>
						</form>
						<script>
							$('#serienjunkies form').submit(function () {
								frm = $(this);
								$.ajax({
									type: frm.attr('method'),
									url: frm.attr('action'),
									data: frm.serialize(),
									success: function(result) {
										$('#captchaid').attr("value", result['id']);
										$('#captchaimg').attr('src', "/" + result['id'] + "/captcha.jpg");
										$('#captchaform').collapse({toggle: true});
									}
								})

								return false;
							});
						</script>
						<form class="collapse sendlinks" id="captchaform" action="/sjcaptcha" method="post">
							<div class="well span4 pagination-centered">
								<p><img src="captcha.jpg" id="captchaimg" /><p />
								<input type="hidden" name="captchaid" value="" id="captchaid" />
								<div class="input-append">
									<input type="text" id="captcha" class="input-small" name="captcha" />
									<input type="submit" class="btn btn-primary" value="Add" />
								</div>
							</div>
						</form>
					</div>
					<div class="tab-pane" id="torrent">
							<p>Not yet implemented</p>
					</div>
			</div>
					<script>
						$('form.sendlinks').submit(function () {
							frm = $(this)
							$.ajax({
							    type: frm.attr('method'),
							    url: frm.attr('action'),
							    data: frm.serialize(),
							    success: function (data) {
								    $('.collapse').collapse({toggle: false});
								    addMessage(data['message']);
							    }
							});
							frm.find('textarea').val('');

							return false;
						});
					</script>
			<div id="messagearea">
			</div>
			<div class="row">
				<div class="span12" style="text-align: center;">
					<h2>Queue</h2>
				</div>
			</div>
			<div class="row">
				<div>
					<div class="span12">
						<ul id="queue" class="well" style="list-style: none">
						</ul>
					</div>
				</div>
			</div>
		</div>
	</body>

</html>
